<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>CORE EMS â€” P2P</title>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Syne:wght@700;800;900&display=swap" rel="stylesheet">
<style>
:root{
  --safe-top:env(safe-area-inset-top,0px);
  --safe-bottom:env(safe-area-inset-bottom,0px);
  --bg:#030712;--surface:#0f172a;--card:#1e293b;
  --border:#1e293b;--border2:#334155;--muted:#475569;--text:#f1f5f9;
  --blue:#3b82f6;--blue-d:#1d4ed8;--red:#ef4444;--green:#22c55e;--amber:#f59e0b;
}
*,*::before,*::after{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html{height:100%;height:-webkit-fill-available;background:var(--bg);-webkit-text-size-adjust:100%;}
body{
  height:100%;height:-webkit-fill-available;margin:0;padding:0;
  font-family:'Syne',sans-serif;background:var(--bg);color:var(--text);
  overflow:hidden;position:fixed;width:100%;
  display:flex;flex-direction:column;align-items:center;
}
#app{width:100%;max-width:430px;height:100%;display:flex;flex-direction:column;background:var(--surface);overflow:hidden;}

/* CONNECTION SCREEN */
#conn-screen{
flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
padding:24px;padding-top:calc(40px + var(â€“safe-top));gap:14px;overflow-y:auto;
-webkit-overflow-scrolling:touch;
}
.logo-big{font-size:28px;font-weight:900;letter-spacing:-0.05em;color:var(â€“blue);margin-bottom:4px;text-align:center;}
.logo-big span{color:var(â€“text);}
.tagline{font-size:10px;color:var(â€“muted);font-weight:700;letter-spacing:.15em;text-transform:uppercase;text-align:center;margin-bottom:8px;}
.conn-card{background:var(â€“card);border:1px solid var(â€“border2);border-radius:20px;padding:18px;width:100%;}
.conn-card h3{font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:.12em;color:var(â€“muted);margin:0 0 12px;}
.room-code-disp{
font-family:â€˜JetBrains Monoâ€™,monospace;font-size:32px;font-weight:800;
letter-spacing:.18em;color:var(â€“blue);text-align:center;padding:14px;
background:rgba(59,130,246,.08);border-radius:12px;border:1px solid rgba(59,130,246,.2);
margin-bottom:10px;cursor:pointer;user-select:all;-webkit-user-select:all;
}
.copy-hint{font-size:9px;color:var(â€“muted);text-align:center;font-family:â€˜JetBrains Monoâ€™,monospace;}
input.room-input{
width:100%;background:#020617;border:1px solid var(â€“border2);border-radius:12px;
padding:14px;font-family:â€˜JetBrains Monoâ€™,monospace;font-size:22px;font-weight:800;
color:#ffffff;text-align:center;letter-spacing:.2em;outline:none;
-webkit-appearance:none;text-transform:uppercase;transition:border-color .2s;margin-bottom:10px;
-webkit-text-fill-color:#ffffff;
}
input.room-input:focus{border-color:var(â€“blue);}
.divider{
display:flex;align-items:center;gap:10px;color:var(â€“muted);
font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:.1em;margin:4px 0;
}
.divider::before,.divider::after{content:â€™â€™;flex:1;height:1px;background:var(â€“border2);}
.status-row{
display:flex;align-items:center;gap:8px;padding:10px 14px;
background:rgba(0,0,0,.3);border-radius:10px;font-size:10px;
font-family:â€˜JetBrains Monoâ€™,monospace;color:var(â€“muted);width:100%;
}
.sdot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.sdot.waiting{background:var(â€“muted);animation:blink 1.5s infinite;}
.sdot.connecting{background:var(â€“amber);animation:blink .7s infinite;}
.sdot.connected{background:var(â€“green);box-shadow:0 0 6px var(â€“green);}
.sdot.error{background:var(â€“red);}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:.2;}}

/* BUTTONS */
.btn{
width:100%;border:none;border-radius:12px;padding:13px;
font-family:â€˜Syneâ€™,sans-serif;font-size:10px;font-weight:800;
text-transform:uppercase;letter-spacing:.12em;cursor:pointer;
-webkit-appearance:none;transition:transform .1s,filter .15s;
}
.btn:active{transform:scale(.96);}
.btn-blue{background:#2563eb;color:white;}
.btn-blue:active{filter:brightness(.85);}
.btn-green{background:#14532d;color:#86efac;border:1px solid #166534;}
.btn-red{background:#7f1d1d;color:#fca5a5;border:1px solid #991b1b;}
.btn-ghost{background:var(â€“card);color:var(â€“muted);border:1px solid var(â€“border2);}

/* MAIN UI */
#main-ui{display:none;flex:1;flex-direction:column;overflow:hidden;}

header{
padding-top:calc(12px + var(â€“safe-top));padding-bottom:9px;
padding-left:14px;padding-right:14px;
background:var(â€“surface);border-bottom:1px solid var(â€“border);
flex-shrink:0;display:flex;justify-content:space-between;align-items:center;
}
.logo{font-size:16px;font-weight:900;letter-spacing:-.04em;color:var(â€“blue);}
.logo span{color:var(â€“text);}
.hdr-right{display:flex;align-items:center;gap:8px;}
.room-badge{
background:var(â€“card);border:1px solid var(â€“border2);border-radius:8px;
padding:4px 9px;font-family:â€˜JetBrains Monoâ€™,monospace;font-size:9px;
font-weight:800;color:var(â€“muted);display:flex;align-items:center;gap:5px;
}
.room-badge .gdot{width:5px;height:5px;border-radius:50%;background:var(â€“green);box-shadow:0 0 4px var(â€“green);}
.role-btn{
background:var(â€“card);border:1px solid var(â€“border2);border-radius:8px;
padding:5px 10px;font-family:â€˜Syneâ€™,sans-serif;font-size:8px;font-weight:800;
text-transform:uppercase;letter-spacing:.1em;color:#94a3b8;cursor:pointer;
-webkit-appearance:none;transition:all .2s;
}
.role-btn.patient-mode{background:rgba(239,68,68,.15);border-color:rgba(239,68,68,.4);color:#fca5a5;}

/* Vitals bar */
#vitals-bar{display:grid;grid-template-columns:repeat(4,1fr);background:rgba(2,6,23,.8);border-bottom:1px solid var(â€“border);flex-shrink:0;}
.vc{padding:7px 2px;text-align:center;border-right:1px solid rgba(30,41,59,.5);transition:background .3s;}
.vc:last-child{border-right:none;}
.vl{font-family:â€˜JetBrains Monoâ€™,monospace;font-size:7px;color:var(â€“muted);font-weight:700;text-transform:uppercase;letter-spacing:.08em;margin-bottom:2px;}
.vv{font-family:â€˜JetBrains Monoâ€™,monospace;font-size:12px;font-weight:800;letter-spacing:-.02em;color:#94a3b8;transition:color .3s;}
.vc.flash{animation:vFlash .5s ease-out;}
@keyframes vFlash{0%{background:rgba(59,130,246,.25);}100%{background:transparent;}}
.vc.crit .vv{color:var(â€“red);}
.vc.warn .vv{color:var(â€“amber);}
.vc.ok .vv{color:var(â€“green);}

/* ECG */
.ecg{height:2px;background:linear-gradient(90deg,transparent,var(â€“border) 20%,var(â€“border) 80%,transparent);position:relative;overflow:hidden;flex-shrink:0;}
.ecg::after{
content:â€™â€™;position:absolute;top:-6px;left:-80px;width:80px;height:14px;
background:url(â€œdata:image/svg+xml,%3Csvg xmlns=â€˜http://www.w3.org/2000/svgâ€™ viewBox=â€˜0 0 80 14â€™%3E%3Cpath d=â€˜M0 7 L15 7 L20 2 L25 12 L28 0 L33 14 L37 7 L80 7â€™ fill=â€˜noneâ€™ stroke=â€™%232563ebâ€™ stroke-width=â€˜1.5â€™/%3E%3C/svg%3Eâ€) no-repeat;
animation:ecgScroll 2.5s linear infinite;
}
@keyframes ecgScroll{to{left:calc(100% + 80px);}}

/* Tabs */
#tab-bar{display:flex;background:var(â€“surface);border-bottom:1px solid var(â€“border);flex-shrink:0;}
.tab{
flex:1;padding:9px 2px;font-size:8px;font-weight:800;text-transform:uppercase;
letter-spacing:.1em;color:var(â€“muted);background:none;border:none;
border-bottom:2px solid transparent;cursor:pointer;-webkit-appearance:none;transition:all .2s;
}
.tab.active{color:var(â€“blue);border-bottom-color:var(â€“blue);}

/* Panels */
#panels{flex:1;overflow:hidden;display:flex;flex-direction:column;min-height:0;}
.panel{display:none;flex:1;flex-direction:column;min-height:0;overflow:hidden;}
.panel.active{display:flex;}

/* Chat */
#chat-scroll{
flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;
padding:14px;display:flex;flex-direction:column;gap:9px;
}
#chat-scroll::-webkit-scrollbar{display:none;}
.mw{display:flex;width:100%;}
.mw.self{justify-content:flex-end;}
.mw.other{justify-content:flex-start;}
.mw.sys{justify-content:center;}
.mb{max-width:83%;padding:9px 13px;border-radius:17px;font-size:13px;line-height:1.4;word-break:break-word;}
.mw.self .mb{background:#2563eb;border-bottom-right-radius:3px;}
.mw.other .mb{background:var(â€“card);border-top-left-radius:3px;}
.mr{font-size:7px;font-weight:800;opacity:.45;text-transform:uppercase;letter-spacing:.1em;margin-bottom:2px;}
.mt{font-weight:500;color:var(â€“text);}
.sys-msg{
background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.2);
padding:3px 13px;border-radius:99px;font-size:9px;font-weight:800;
text-transform:uppercase;letter-spacing:.1em;color:#93c5fd;
}

#chat-foot{
padding:9px 12px;padding-bottom:calc(9px + var(â€“safe-bottom));
background:var(â€“surface);border-top:1px solid var(â€“border);
display:flex;gap:8px;align-items:center;flex-shrink:0;
}
#chat-in{
flex:1;background:#020617;border:1px solid var(â€“border2);border-radius:22px;
padding:10px 16px;color:#ffffff;font-family:â€˜Syneâ€™,sans-serif;font-size:14px;
font-weight:500;outline:none;-webkit-appearance:none;transition:border-color .2s;
-webkit-text-fill-color:#ffffff;
}
#chat-in:focus{border-color:var(â€“blue);}
#chat-in::placeholder{color:var(â€“border2);}
#send-btn{
width:43px;height:43px;background:#2563eb;border:none;border-radius:50%;
display:flex;align-items:center;justify-content:center;cursor:pointer;
flex-shrink:0;-webkit-appearance:none;transition:transform .12s,filter .15s;
}
#send-btn:active{transform:scale(.86);filter:brightness(.8);}

/* Vitals edit panel */
#panel-vitals{overflow-y:auto;-webkit-overflow-scrolling:touch;}
.vedit-wrap{padding:14px;display:flex;flex-direction:column;gap:11px;}
.vedit-card{background:var(â€“card);border:1px solid var(â€“border2);border-radius:14px;padding:13px 14px;}
.vedit-card label{display:block;font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:.1em;color:var(â€“muted);margin-bottom:7px;}
.vedit-card input,.vedit-card select{
width:100%;background:#020617;border:1px solid var(â€“border2);border-radius:10px;
padding:10px 13px;color:#ffffff;font-family:â€˜JetBrains Monoâ€™,monospace;
font-size:16px;font-weight:700;outline:none;-webkit-appearance:none;transition:border-color .2s;
-webkit-text-fill-color:#ffffff;
}
.vedit-card input:focus,.vedit-card select:focus{border-color:var(â€“blue);}
.vhint{font-size:9px;color:var(â€“muted);margin-top:5px;font-family:â€˜JetBrains Monoâ€™,monospace;}
.patient-only-note{
font-size:10px;color:var(â€“amber);text-align:center;padding:12px;
background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.2);
border-radius:12px;font-family:â€˜JetBrains Monoâ€™,monospace;
}

/* Typing */
.typing-wrap{display:flex;}
.typing-bubble{display:flex;gap:4px;align-items:center;padding:12px 14px;background:var(â€“card);border-radius:17px;border-top-left-radius:3px;}
.tdot{width:6px;height:6px;border-radius:50%;background:var(â€“muted);animation:tdot 1.2s infinite;}
.tdot:nth-child(2){animation-delay:.2s;}
.tdot:nth-child(3){animation-delay:.4s;}
@keyframes tdot{0%,60%,100%{transform:translateY(0);opacity:.4;}30%{transform:translateY(-5px);opacity:1;}}

/* Modals */
.modal{
position:fixed;inset:0;background:rgba(0,0,0,.88);
backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);
z-index:100;display:flex;align-items:center;justify-content:center;
padding:24px;animation:mFadeIn .22s ease-out;
}
.modal.hidden{display:none;}
@keyframes mFadeIn{from{opacity:0;transform:scale(.95);}to{opacity:1;transform:scale(1);}}
.modal-box{
background:var(â€“surface);border:1px solid var(â€“border2);border-radius:22px;
padding:26px 22px;width:100%;max-width:320px;text-align:center;
}

::-webkit-scrollbar{display:none;}
</style>

</head>
<body>
<div id="app">

<!-- â•â•â•â•â•â•â•â•â•â•â•â• CONNECTION SCREEN â•â•â•â•â•â•â•â•â•â•â•â• -->

<div id="conn-screen">
  <div>
    <div class="logo-big">CORE <span>EMS</span></div>
    <div class="tagline">P2P Simulator</div>
  </div>

  <!-- HOST: create room -->

  <div class="conn-card" id="card-host">
    <h3>ğŸ¥ æ‚£è€…å½¹ â€” ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ</h3>
    <div class="room-code-disp" id="my-room-code">------</div>
    <div class="copy-hint">ã‚¿ãƒƒãƒ—ã§ã‚³ãƒ”ãƒ¼</div>
  </div>

  <div class="divider">ã¾ãŸã¯</div>

  <!-- JOIN: enter room code -->

  <div class="conn-card">
    <h3>ğŸš‘ æ•‘æ€¥éšŠå“¡å½¹ â€” ãƒ«ãƒ¼ãƒ ã«å‚åŠ </h3>
    <input class="room-input" id="join-input" placeholder="XXXXXX" maxlength="6" inputmode="text" autocomplete="off" autocorrect="off" autocapitalize="characters">
    <button class="btn btn-blue" onclick="joinRoom()">å‚åŠ ã™ã‚‹</button>
  </div>

  <!-- Status -->

  <div class="status-row" id="status-row">
    <div class="sdot waiting" id="status-dot"></div>
    <span id="status-text">æ¥ç¶šå¾…æ©Ÿä¸­...</span>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• MAIN UI â•â•â•â•â•â•â•â•â•â•â•â• -->

<div id="main-ui">
  <header>
    <div class="logo">CORE <span>EMS</span></div>
    <div class="hdr-right">
      <div class="room-badge">
        <div class="gdot"></div>
        <span id="hdr-room-code">------</span>
      </div>
      <button class="role-btn" id="role-btn" onclick="toggleRole()">PARAMEDIC</button>
    </div>
  </header>

  <div id="vitals-bar">
    <div class="vc" id="vc-bp"><div class="vl">BP</div><div class="vv" id="vv-bp">--/--</div></div>
    <div class="vc" id="vc-hr"><div class="vl">HR</div><div class="vv" id="vv-hr">--</div></div>
    <div class="vc" id="vc-jcs"><div class="vl">JCS</div><div class="vv" id="vv-jcs">--</div></div>
    <div class="vc" id="vc-spo2"><div class="vl">SpO2</div><div class="vv" id="vv-spo2">--%</div></div>
  </div>
  <div class="ecg"></div>

  <div id="tab-bar">
    <button class="tab active" onclick="switchTab('chat',this)">ğŸ“Ÿ é€šä¿¡</button>
    <button class="tab" onclick="switchTab('vitals',this)">ğŸ“Š ãƒã‚¤ã‚¿ãƒ«</button>
    <button class="tab" onclick="switchTab('info',this)">ğŸ“‹ æƒ…å ±</button>
  </div>

  <div id="panels">
    <!-- Chat -->
    <div class="panel active" id="panel-chat">
      <div id="chat-scroll"></div>
      <div id="chat-foot">
        <input type="text" id="chat-in" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." autocomplete="off" autocorrect="off" autocapitalize="off">
        <button id="send-btn" onclick="sendChat()">
          <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
        </button>
      </div>
    </div>

```
<!-- Vitals -->
<div class="panel" id="panel-vitals">
  <div class="vedit-wrap">
    <div id="patient-only-note" class="patient-only-note hidden">âš ï¸ æ‚£è€…å½¹ã®ã¿ãƒã‚¤ã‚¿ãƒ«ã‚’æ›´æ–°ã§ãã¾ã™</div>
    <div class="vedit-card">
      <label>è¡€åœ§ (BP)</label>
      <input type="text" id="edit-bp" placeholder="120/80" inputmode="text">
      <div class="vhint">æ­£å¸¸: 90-139/60-89 mmHg</div>
    </div>
    <div class="vedit-card">
      <label>å¿ƒæ‹æ•° (HR)</label>
      <input type="number" id="edit-hr" placeholder="80" inputmode="numeric" min="0" max="300">
      <div class="vhint">æ­£å¸¸: 60-100 bpm</div>
    </div>
    <div class="vedit-card">
      <label>æ„è­˜ãƒ¬ãƒ™ãƒ« (JCS)</label>
      <select id="edit-jcs">
        <option value="0">JCS 0 â€” æ¸…æ˜</option>
        <option value="1">JCS 1 â€” åˆºæ¿€ãªã—ã§è¦šé†’</option>
        <option value="2">JCS 2 â€” åˆºæ¿€ã§è¦šé†’</option>
        <option value="3">JCS 3 â€” åˆºæ¿€ã—ã¦ã‚‚è¦šé†’ã—ãªã„</option>
        <option value="10">JCS 10 â€” æ™®é€šã®å‘¼ã³ã‹ã‘ã§å¿œã˜ã‚‹</option>
        <option value="20">JCS 20 â€” å¤§ããªå£°ã§å¿œã˜ã‚‹</option>
        <option value="30">JCS 30 â€” ç—›ã¿ã§è¾›ã†ã˜ã¦å¿œã˜ã‚‹</option>
        <option value="100">JCS 100 â€” æ‰•ã„ã®ã‘ã‚‹å‹•ä½œ</option>
        <option value="200">JCS 200 â€” å°‘ã—æ‰‹è¶³å‹•ã‹ã™</option>
        <option value="300">JCS 300 â€” å…¨ãå‹•ã‹ãªã„</option>
      </select>
    </div>
    <div class="vedit-card">
      <label>é…¸ç´ é£½å’Œåº¦ (SpO2)</label>
      <input type="number" id="edit-spo2" placeholder="98" inputmode="numeric" min="50" max="100">
      <div class="vhint">æ­£å¸¸: 96-100%</div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
      <button class="btn btn-blue" id="update-btn" onclick="updateVitals()">ãƒã‚¤ã‚¿ãƒ«æ›´æ–°</button>
      <button class="btn btn-green" id="arrival-btn" onclick="triggerArrival()">ç—…é™¢åˆ°ç€</button>
    </div>
    <button class="btn btn-red" onclick="openReset()">ãƒªã‚»ãƒƒãƒˆ</button>
  </div>
</div>

<!-- Info -->
<div class="panel" id="panel-info">
  <div style="flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:16px;display:flex;flex-direction:column;gap:12px;">
    <div class="vedit-card">
      <label>ğŸ”— P2Pæ¥ç¶šã®ä½¿ã„æ–¹</label>
      <div style="font-size:11px;color:#94a3b8;line-height:1.7;">
        <strong style="color:var(--text);">1. æ‚£è€…å½¹</strong>ãŒã‚¢ãƒ—ãƒªã‚’é–‹ãã¨6æ¡ã®ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚<br>
        <strong style="color:var(--text);">2. æ•‘æ€¥éšŠå“¡å½¹</strong>ã¯ãã®ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ã€Œå‚åŠ ã™ã‚‹ã€ã‚’ã‚¿ãƒƒãƒ—ã€‚<br>
        <strong style="color:var(--text);">3. æ¥ç¶šå¾Œ</strong>ã¯ãƒãƒ£ãƒƒãƒˆãƒ»ãƒã‚¤ã‚¿ãƒ«ãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸã—ã¾ã™ã€‚
      </div>
    </div>
    <div class="vedit-card">
      <label>ğŸ­ ãƒ­ãƒ¼ãƒ«</label>
      <div style="font-size:11px;color:#94a3b8;line-height:1.7;">
        <strong style="color:var(--text);">PARAMEDIC:</strong> ãƒãƒ£ãƒƒãƒˆã§æ‚£è€…ã«å•è¨ºãƒ»æŒ‡ç¤º<br>
        <strong style="color:var(--text);">PATIENT:</strong> ãƒã‚¤ã‚¿ãƒ«ã‚¿ãƒ–ã§ãƒã‚¤ã‚¿ãƒ«ã‚’æ›´æ–°ãƒ»ç›¸æ‰‹ã«é€ä¿¡
      </div>
    </div>
    <div class="vedit-card">
      <label>ğŸ“Š ãƒã‚¤ã‚¿ãƒ«åŸºæº–å€¤</label>
      <div style="font-size:11px;color:#94a3b8;font-family:'JetBrains Mono',monospace;line-height:1.9;">
        BP: æ­£å¸¸ 90-139/60-89 mmHg<br>
        HR: æ­£å¸¸ 60-100 bpm<br>
        JCS: 0=æ¸…æ˜ã€æ•°å€¤â†‘=æ„è­˜éšœå®³<br>
        SpO2: æ­£å¸¸ 96-100%ï¼ˆ90%â†“=å±é™ºï¼‰
      </div>
    </div>
    <div style="padding:12px;background:rgba(59,130,246,.07);border:1px solid rgba(59,130,246,.18);border-radius:12px;">
      <div style="font-size:9px;color:#93c5fd;font-weight:800;margin-bottom:3px;">CORE EMS Simulator â€” P2Pç‰ˆ</div>
      <div style="font-size:10px;color:var(--muted);font-family:'JetBrains Mono',monospace;">æ•™è‚²ãƒ»è¨“ç·´ç›®çš„å°‚ç”¨<br>å®Ÿéš›ã®åŒ»ç™‚åˆ¤æ–­ã«ä½¿ç”¨ã—ãªã„ã“ã¨</div>
    </div>
  </div>
</div>
```

  </div>
</div>

<!-- Arrival Modal -->

<div class="modal hidden" id="arrival-modal">
  <div class="modal-box">
    <div style="font-size:48px;margin-bottom:10px;">ğŸ¥</div>
    <div style="font-size:17px;font-weight:900;letter-spacing:-.03em;margin-bottom:6px;">ç—…é™¢ã«åˆ°ç€ã—ã¾ã—ãŸ</div>
    <div style="font-size:11px;color:var(--muted);margin-bottom:22px;font-family:'JetBrains Mono',monospace;">æ‚£è€…ã‚’åŒ»ç™‚ã‚¹ã‚¿ãƒƒãƒ•ã«å¼•ãç¶™ãã¾ã—ãŸ</div>
    <button class="btn btn-blue" onclick="closeArrival()">é–‰ã˜ã‚‹</button>
  </div>
</div>

<!-- Reset Modal -->

<div class="modal hidden" id="reset-modal">
  <div class="modal-box">
    <div style="font-size:12px;font-weight:900;color:var(--red);text-transform:uppercase;letter-spacing:.1em;margin-bottom:10px;">ãƒªã‚»ãƒƒãƒˆç¢ºèª</div>
    <div style="font-size:11px;color:var(--muted);margin-bottom:20px;">å…¨ãƒ‡ãƒ¼ã‚¿ã¨ä¼šè©±ã‚’åˆæœŸåŒ–ã—ã¾ã™</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
      <button class="btn btn-ghost" onclick="closeReset()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-red" onclick="doReset()">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </div>
</div>

<script>
// â”€â”€â”€ State â”€â”€â”€
let peer = null;
let conn = null;
let myRole = 'paramedic';
let isHost = false;
let myRoomCode = '';
let vitals = { bp:'--/--', hr:'--', jcs:'--', spo2:'--%' };

// â”€â”€â”€ Generate 6-char room code â”€â”€â”€
function genCode() {
  return Math.random().toString(36).substring(2,8).toUpperCase();
}

// â”€â”€â”€ Init as HOST (patient side creates the room) â”€â”€â”€
function initHost() {
  myRoomCode = genCode();
  document.getElementById('my-room-code').textContent = myRoomCode;
  document.getElementById('my-room-code').onclick = () => {
    navigator.clipboard?.writeText(myRoomCode).catch(()=>{});
    document.getElementById('my-room-code').textContent = 'COPIED!';
    setTimeout(()=> document.getElementById('my-room-code').textContent = myRoomCode, 1200);
  };

  setStatus('connecting', 'PeerJSã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šä¸­...');
  peer = new Peer('ems-' + myRoomCode, { debug: 0 });

  peer.on('open', () => {
    isHost = true;
    setStatus('waiting', 'ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰: ' + myRoomCode + ' â€” ç›¸æ‰‹ã®æ¥ç¶šã‚’å¾…æ©Ÿä¸­');
  });

  peer.on('connection', (c) => {
    conn = c;
    setupConn();
    setStatus('connected', 'æ¥ç¶šå®Œäº†ï¼ ãƒ«ãƒ¼ãƒ : ' + myRoomCode);
    setTimeout(() => showMainUI(), 800);
  });

  peer.on('error', (e) => {
    if (e.type === 'unavailable-id') {
      // Code taken, try again
      peer.destroy();
      initHost();
    } else {
      setStatus('error', 'ã‚¨ãƒ©ãƒ¼: ' + e.type);
    }
  });
}

// â”€â”€â”€ Join as GUEST (paramedic side) â”€â”€â”€
function joinRoom() {
  const raw = document.getElementById('join-input').value.trim().toUpperCase();
  if (raw.length < 4) { setStatus('error', '6æ¡ã®ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const code = raw.length === 6 ? raw : raw;

  setStatus('connecting', 'æ¥ç¶šä¸­... (' + code + ')');
  peer = new Peer(undefined, { debug: 0 });

  peer.on('open', () => {
    conn = peer.connect('ems-' + code, { reliable: true });
    setupConn();
    conn.on('open', () => {
      myRoomCode = code;
      isHost = false;
      setStatus('connected', 'æ¥ç¶šå®Œäº†ï¼ ãƒ«ãƒ¼ãƒ : ' + code);
      setTimeout(() => showMainUI(), 600);
    });
  });

  peer.on('error', (e) => {
    setStatus('error', 'æ¥ç¶šå¤±æ•—: ' + e.type + ' â€” ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
  });
}

// â”€â”€â”€ Setup data channel â”€â”€â”€
function setupConn() {
  conn.on('data', (data) => {
    if (data.type === 'chat') {
      renderMsg(data.text, data.role, false);
    } else if (data.type === 'vitals') {
      applyVitals(data.vitals);
      addSysMsg('ğŸ“Š ãƒã‚¤ã‚¿ãƒ«æ›´æ–°: BP ' + data.vitals.bp + ' HR ' + data.vitals.hr + ' JCS ' + data.vitals.jcs + ' SpO2 ' + data.vitals.spo2);
    } else if (data.type === 'arrived') {
      document.getElementById('arrival-modal').classList.remove('hidden');
    } else if (data.type === 'reset') {
      doResetLocal();
      addSysMsg('ğŸ”„ ç›¸æ‰‹ãŒãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
    } else if (data.type === 'sys') {
      addSysMsg(data.text);
    }
  });

  conn.on('close', () => {
    addSysMsg('âš ï¸ ç›¸æ‰‹ã¨ã®æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ');
  });
}

// â”€â”€â”€ Show main UI â”€â”€â”€
function showMainUI() {
  document.getElementById('conn-screen').style.display = 'none';
  const mu = document.getElementById('main-ui');
  mu.style.display = 'flex';
  mu.style.flexDirection = 'column';
  document.getElementById('hdr-room-code').textContent = myRoomCode;

  // Host defaults to PATIENT role, Guest defaults to PARAMEDIC
  if (isHost) {
    myRole = 'patient';
    document.getElementById('role-btn').textContent = 'PATIENT';
    document.getElementById('role-btn').classList.add('patient-mode');
  }

  addSysMsg('ğŸš‘ æ¥ç¶šå®Œäº† â€” ãƒ«ãƒ¼ãƒ  ' + myRoomCode);
  addSysMsg(isHost ? 'ğŸ”´ ã‚ãªãŸã¯æ‚£è€…å½¹ã§ã™' : 'ğŸ”µ ã‚ãªãŸã¯æ•‘æ€¥éšŠå“¡å½¹ã§ã™');
  updatePatientControls();
}

// â”€â”€â”€ Status helpers â”€â”€â”€
function setStatus(state, text) {
  const dot = document.getElementById('status-dot');
  dot.className = 'sdot ' + state;
  document.getElementById('status-text').textContent = text;
}

// â”€â”€â”€ Tab switching â”€â”€â”€
function switchTab(name, btn) {
  document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.panel').forEach(p => { p.style.display='none'; p.classList.remove('active'); });
  const panel = document.getElementById('panel-' + name);
  if (panel) { panel.style.display = 'flex'; panel.classList.add('active'); }
}

// â”€â”€â”€ Role toggle â”€â”€â”€
function toggleRole() {
  myRole = myRole === 'paramedic' ? 'patient' : 'paramedic';
  const btn = document.getElementById('role-btn');
  btn.textContent = myRole.toUpperCase();
  btn.classList.toggle('patient-mode', myRole === 'patient');
  addSysMsg(myRole === 'patient' ? 'ğŸ”´ æ‚£è€…ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ' : 'ğŸ”µ æ•‘æ€¥éšŠå“¡ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ');
  updatePatientControls();
}

function updatePatientControls() {
  const isPatient = myRole === 'patient';
  const note = document.getElementById('patient-only-note');
  const editInputs = document.querySelectorAll('.vedit-card input, .vedit-card select');
  const updateBtn = document.getElementById('update-btn');
  const arrivalBtn = document.getElementById('arrival-btn');
  note.classList.toggle('hidden', isPatient);
  editInputs.forEach(el => el.disabled = !isPatient);
  updateBtn.disabled = !isPatient;
  arrivalBtn.disabled = !isPatient;
  updateBtn.style.opacity = isPatient ? '1' : '.4';
  arrivalBtn.style.opacity = isPatient ? '1' : '.4';
}

// â”€â”€â”€ Vitals â”€â”€â”€
function applyVitals(v) {
  vitals = { ...vitals, ...v };
  setVital('bp', v.bp);
  setVital('hr', v.hr);
  setVital('jcs', v.jcs);
  setVital('spo2', v.spo2);
}

function setVital(key, val) {
  if (!val) return;
  const el = document.getElementById('vv-' + key);
  const cell = document.getElementById('vc-' + key);
  if (!el) return;
  el.textContent = val;
  cell.classList.remove('flash','crit','warn','ok');
  if (key === 'hr') {
    const n = parseInt(val);
    if (n < 50 || n > 130) cell.classList.add('crit');
    else if (n < 60 || n > 100) cell.classList.add('warn');
    else cell.classList.add('ok');
  } else if (key === 'spo2') {
    const n = parseInt(val);
    if (n < 90) cell.classList.add('crit');
    else if (n < 95) cell.classList.add('warn');
    else cell.classList.add('ok');
  } else if (key === 'jcs') {
    const n = parseInt(val);
    if (n >= 100) cell.classList.add('crit');
    else if (n >= 10) cell.classList.add('warn');
    else if (n === 0) cell.classList.add('ok');
  } else if (key === 'bp') {
    const sys = parseInt(val.split('/')[0]);
    if (sys < 90 || sys > 160) cell.classList.add('crit');
    else if (sys < 100 || sys > 139) cell.classList.add('warn');
    else cell.classList.add('ok');
  }
  void cell.offsetWidth;
  cell.classList.add('flash');
}

function updateVitals() {
  if (myRole !== 'patient') return;
  const v = {
    bp: document.getElementById('edit-bp').value || '--/--',
    hr: document.getElementById('edit-hr').value || '--',
    jcs: document.getElementById('edit-jcs').value,
    spo2: (document.getElementById('edit-spo2').value || '--') + '%'
  };
  applyVitals(v);
  addSysMsg('ğŸ“Š ãƒã‚¤ã‚¿ãƒ«æ›´æ–°é€ä¿¡ä¸­...');
  send({ type: 'vitals', vitals: v });
}

// â”€â”€â”€ Chat â”€â”€â”€
function sendChat() {
  const inp = document.getElementById('chat-in');
  const text = inp.value.trim();
  if (!text) return;
  inp.value = '';
  renderMsg(text, myRole, true);
  send({ type: 'chat', text, role: myRole });
}

function renderMsg(text, role, self) {
  const c = document.getElementById('chat-scroll');
  const div = document.createElement('div');
  div.className = 'mw ' + (self ? 'self' : 'other');
  div.innerHTML = `<div class="mb"><div class="mr">${esc(role)}</div><div class="mt">${esc(text)}</div></div>`;
  c.appendChild(div);
  c.scrollTop = c.scrollHeight;
}

function addSysMsg(text) {
  const c = document.getElementById('chat-scroll');
  const div = document.createElement('div');
  div.className = 'mw sys';
  div.innerHTML = `<div class="sys-msg">${esc(text)}</div>`;
  c.appendChild(div);
  c.scrollTop = c.scrollHeight;
}

// â”€â”€â”€ Arrival â”€â”€â”€
function triggerArrival() {
  if (myRole !== 'patient') return;
  document.getElementById('arrival-modal').classList.remove('hidden');
  send({ type: 'arrived' });
}
function closeArrival() {
  document.getElementById('arrival-modal').classList.add('hidden');
  addSysMsg('ğŸ¥ ç—…é™¢ã«åˆ°ç€ã—ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†');
}

// â”€â”€â”€ Reset â”€â”€â”€
function openReset() { document.getElementById('reset-modal').classList.remove('hidden'); }
function closeReset() { document.getElementById('reset-modal').classList.add('hidden'); }
function doReset() {
  closeReset();
  doResetLocal();
  send({ type: 'reset' });
  addSysMsg('ğŸ”„ ãƒªã‚»ãƒƒãƒˆå®Œäº†');
}
function doResetLocal() {
  ['bp','hr','jcs','spo2'].forEach(k => setVital(k, k === 'spo2' ? '--%' : '--'));
  vitals = { bp:'--/--', hr:'--', jcs:'--', spo2:'--%' };
  ['edit-bp','edit-hr','edit-spo2'].forEach(id => { const el = document.getElementById(id); if(el) el.value=''; });
  const jcsEl = document.getElementById('edit-jcs');
  if (jcsEl) jcsEl.selectedIndex = 0;
  document.getElementById('chat-scroll').innerHTML = '';
}

// â”€â”€â”€ P2P send â”€â”€â”€
function send(data) {
  try { if (conn && conn.open) conn.send(data); } catch(e) { console.warn('Send failed', e); }
}

// â”€â”€â”€ Escape â”€â”€â”€
function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// â”€â”€â”€ Event listeners â”€â”€â”€
document.getElementById('chat-in').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); }
});
document.getElementById('join-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') joinRoom();
});

// â”€â”€â”€ Boot: always start as host first â”€â”€â”€
initHost();
</script>

</body>
</html>